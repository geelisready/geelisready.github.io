<!doctype html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="geelin的知识小窝">
<meta property="og:url" content="https://geelisready.github.io/index.html">
<meta property="og:site_name" content="geelin的知识小窝">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="geelin的知识小窝">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://geelisready.github.io/"/>





  <title> geelin的知识小窝 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">geelin的知识小窝</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://geelisready.github.io/2017/04/12/machine learning/knn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="geelin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="geelin的知识小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/12/machine learning/knn/" itemprop="url">
                  k近邻原理与实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-12T21:29:48+08:00">
                2017-04-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>tags:[machine learning]</p>
<p>最近重新复习了knn并整理了knn的具体实现的知识，博客分为几个部分：</p>
<ul>
<li>knn原理及原理级的代码实现</li>
<li>kd树的实现</li>
</ul>
<h1 id="1、概念与原理"><a href="#1、概念与原理" class="headerlink" title="1、概念与原理"></a>1、概念与原理</h1><hr>
<p><strong>优缺点：</strong></p>
<ul>
<li>适合多分类的情况</li>
<li><strong>精度高，对异常值不敏感，无数据输入假定</strong></li>
<li>计算复杂度高、空间复杂度高</li>
<li>对比贝叶斯速度慢，但对输入值无要求</li>
</ul>
<p><strong>能力范围：</strong> 适用数据范围：数值型或标称型</p>
<hr>
<h2 id="1-1-算法简介"><a href="#1-1-算法简介" class="headerlink" title="1.1    算法简介"></a><strong>1.1    算法简介</strong></h2><blockquote>
<p>K最近邻(k-Nearest Neighbour，KNN)分类算法，是一个理论上比较成熟的方法，也是最简单的机器学习算法之一。该方法的思路是：如果一个样本在特征空间中的k个最相似(即特征空间中最邻近)的样本中的大多数属于某一个类别，则该样本也属于这个类别。</p>
</blockquote>
<p>以上是百度百科的简单解释。k近邻算法通俗地讲就是把待分类的样本与所有已知分类的样本比较相似性，相似性通常使用距离作为度量。给定一个待分类样本点，找到k个与其距离最近的k个已知分类的样本点，把这k个样本中标签数量最多的类作为待分类样本点的预测。</p>
<h3 id="k近邻的三要素："><a href="#k近邻的三要素：" class="headerlink" title="k近邻的三要素："></a>k近邻的三要素：</h3><ul>
<li>k值的选择（最近邻点个数）：</li>
<li>距离度量（度量两个样本点的距离算法）</li>
<li>分类决策规则</li>
</ul>
<hr>
<h2 id="1-2、算法基本原理"><a href="#1-2、算法基本原理" class="headerlink" title="1.2、算法基本原理:"></a>1.2、算法基本原理:</h2><ul>
<li>设定使用距离度量与k值<ul>
<li>距离选择的不同，如马氏距离的p值选择不同，亦会使得最近邻点改变</li>
<li>k值指的是与输入的样本点最近的k个样本点。<ul>
<li>比如有三种电影类型的样本点：动作片，爱情片，恐怖片。假设k=3，而与输入的样本点最近的三个样本点为有两个是动作片，一个是爱情片，则判断输入的样本点为动作片<br>找到与输入的样本点最近的三个样本点，确定最可能的类</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>k值的选择对应的预测问题：</p>
<ul>
<li>选择较小的k值：即用较小邻域中的训练实例来预测</li>
<li>选择较大的k值：即用较大邻域中的训练实例来预测</li>
<li>k=N（样本数）：预测其属于训练实例中最多的类</li>
</ul>
</li>
<li><p>交叉验证<br>k一般先取一个较小的值，然后通过<strong>交叉验证</strong>来确定。交叉验证即将训练样本划分一部分出来为预测样本，比如75%训练，25%预测，然后k分别取1，2，3，4，5之类的，进行预测，计算最后的分类误差，选择误差最小的k。</p>
</li>
</ul>
<hr>
<h2 id="1-3、简单代码实现"><a href="#1-3、简单代码实现" class="headerlink" title="1.3、简单代码实现"></a>1.3、简单代码实现</h2><hr>
<ul>
<li>代码思路：<ul>
<li>先计算输入样本点x与数据集中每一个点的距离（这里默认为欧式距离1/2 * (x^2 + y^2)）</li>
<li>找到离输入样本点x最近的k个最近邻点，得到它们的下标</li>
<li>计算k个最近邻点中所属样本最多的类别作为x的预测类输出</li>
</ul>
</li>
</ul>
<h4 id="1-3-1、-python实现代码："><a href="#1-3-1、-python实现代码：" class="headerlink" title="1.3.1、 python实现代码："></a>1.3.1、 <strong>python实现代码：</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">computeKNN</span><span class="params">(inX, dataSet, labels, k)</span>:</span></div><div class="line">	<span class="comment"># inX is the input sample, dataSet is ndarray containing points</span></div><div class="line">	<span class="comment"># labels contain the counterpart label of the points in dataSet</span></div><div class="line">	<span class="comment"># k is the num of the point which is closest to the sample</span></div><div class="line">	size_dataSet = dataSet.shape[<span class="number">0</span>]</div><div class="line">		<span class="comment"># dataSet is a array, and dataSet.shape is a tuple</span></div><div class="line">		<span class="comment"># which return the info of the shape of dataSet.</span></div><div class="line">		<span class="comment"># dataSet.shape[0] return the num of rows</span></div><div class="line">	<span class="comment">#compute distance</span></div><div class="line">	diffMat = np.tile(inX, (size_dataSet, <span class="number">1</span>)) - dataSet</div><div class="line">		<span class="comment"># np.tile(inX, (size_dataSet, 1)) is used to create</span></div><div class="line">		<span class="comment"># a set filled with the points inX(sample)</span></div><div class="line">		<span class="comment"># with size:(size_dataSet, 1)</span></div><div class="line">	sqDiffMat = diffMat ** <span class="number">2</span></div><div class="line">		<span class="comment"># oompute the square of distance (x^2, y^2)</span></div><div class="line">		<span class="comment"># '**' is similaer to the operator '.*' in matlab</span></div><div class="line">	sqDistances = sqDiffMat.sum(axis = <span class="number">1</span>)</div><div class="line">		<span class="comment"># cmopute the sum of two square item in every sample.</span></div><div class="line">		<span class="comment">#(axis = 1) means that retain the first axis(dim)</span></div><div class="line">	distances = sqDistances ** <span class="number">0.5</span></div><div class="line">		<span class="comment"># 1/2 * (x^2 + y^2)</span></div><div class="line">	sortedDistIndicies = distances.argsort()</div><div class="line">		<span class="comment"># get the index of point which is closest to the sample</span></div><div class="line">		<span class="comment"># in order</span></div><div class="line">	classCount = &#123;&#125;</div><div class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(k):</div><div class="line">		voteIlabel = labels[sortedDistIndicies[i]]</div><div class="line">			<span class="comment"># get the label of clost</span></div><div class="line">		classCount[voteIlabel] = classCount.get(voteIlabel, <span class="number">0</span>) + <span class="number">1</span></div><div class="line">			<span class="comment"># create a dict to record the frequent num of the labels</span></div><div class="line">			<span class="comment"># classCount.get(a, b): if a's key in classCount,</span></div><div class="line">			<span class="comment"># return a's value, else return b</span></div><div class="line">	sortedDistIndicies = sorted(classCount.items(), key = operator.itemgetter(<span class="number">1</span>), reverse = <span class="keyword">True</span>)</div><div class="line">			<span class="comment"># get the result: [('B', 2), ('A', 2)]</span></div><div class="line">			<span class="comment"># classCount.items(): return the content of classCount</span></div><div class="line">	<span class="keyword">return</span> sortedDistIndicies[<span class="number">0</span>][<span class="number">0</span>]</div><div class="line">			<span class="comment"># return 'B'</span></div></pre></td></tr></table></figure>
<ul>
<li>测试部分：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">import handwritingRecognition_knn as hr_knn</div><div class="line">import matplotlib</div><div class="line">import matplotlib.pyplot as plt</div><div class="line">import numpy as np</div><div class="line">import pdb</div><div class="line">from os import listdir</div><div class="line"></div><div class="line"></div><div class="line">testVector = hr_knn.img2vector(</div><div class="line">				&apos;f:\codeGit\dataset\d_0.txt&apos;)</div><div class="line">trainingFileList = listdir(&apos;f:/codeGit/dataset/digits/trainingDigits&apos;)</div><div class="line">hr_knn.handwritingClassTest()</div></pre></td></tr></table></figure>
<ul>
<li>运行结果：<br><img src="http://img.blog.csdn.net/20160416142207465" alt="这里写图片描述"></li>
</ul>
<h4 id="1-3-2、-java实现代码："><a href="#1-3-2、-java实现代码：" class="headerlink" title="1.3.2、 java实现代码："></a>1.3.2、 <strong>java实现代码：</strong></h4><p>python实现是使用了python的第三方库numpy中的矩阵数据结构来存储数据集，但java没有专门的库，而且最后排序仅能得到k近邻的点，却无法得到其下标</p>
<ul>
<li>针对这些问题：<ul>
<li>可以使ArrayList<arraylist<t>&gt;（ArrayList的基类的List）来实现数据集的存储。</arraylist<t></li>
<li>定义knn_node节点类型，其用于定义某个数据集中点的属性集合，包括：下标、所属类别、以及距离属性（距离属性用于存储其距离当前输入测试样本的距离，输入样本换了，则仅距离属性会改变）</li>
<li>使用优先队列来存储k个最近领knn节点，使用一个哈希表统计k近邻中数量最大的类。</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">package isolated_algo;</div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.Arrays;</div><div class="line">import java.util.Map;</div><div class="line">import java.util.HashMap;</div><div class="line">import java.util.Iterator;</div><div class="line">import java.util.PriorityQueue;</div><div class="line"></div><div class="line">public class KNN &#123;</div><div class="line"></div><div class="line">	public KNN(List&lt;List&lt;Double&gt;&gt; dataset, List&lt;Double&gt; inputSample, int k)&#123;</div><div class="line"></div><div class="line">		PriorityQueue&lt;KNN_node&gt; pq = new PriorityQueue&lt;KNN_node&gt;(k, comparator);</div><div class="line">		// 下面的代码用随机样本点初始化优先队列</div><div class="line">		List&lt;Integer&gt; randNum = getRandKIdx(k, datas.size());</div><div class="line">		for (int i = 0; i &lt; k; i++)&#123;</div><div class="line">			int index = randNum.get(i);</div><div class="line">			List&lt;Double&gt; curData = dataset.get(index);</div><div class="line">			String c = curData.get(curData.size() - 1).toString();</div><div class="line">			KNN_node node = new KNN_node(index, label, calDistance(curData, inputSample))</div><div class="line">			pq.add(node);</div><div class="line">		&#125;</div><div class="line">		// 计算数据集dataset中每个样本与inputSample的距离，</div><div class="line">		// 根据与优先队列的最后元素比较大小，判断需要塞入k大小的优先队列中</div><div class="line">		for (int i = 0; i &lt; dataset.size(); i++)&#123;</div><div class="line">			List&lt;Double&gt; sample = dataset.get(i);</div><div class="line">			double distance = calDistance(inputSample, sample);</div><div class="line">			KNN_node top = top.peek();</div><div class="line">			if (top.getDistance() &gt; distance) &#123;</div><div class="line">				pq.remove();</div><div class="line">				pq.add(new KNN_node(index, sample.get(sample.size() - 1).toString()), distance);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		// 得到最有可能的类</div><div class="line">		return getMostClass(pq);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public Comparator&lt;KNN_node&gt; comparator = new Comparator&lt;KNN_node&gt;()&#123;</div><div class="line">	// 创建一个比较器用于优先队列中KNN_node进行距离比较</div><div class="line">		public int compara(KNN_node o1, KNN_node o2)&#123;</div><div class="line">			if (o1.getDistance() &gt;= o2.getDistance())&#123;</div><div class="line">				return 1;</div><div class="line">			&#125; else &#123;</div><div class="line">				return 0;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public List&lt;Integer&gt; getRandKIdx(int k, int max)&#123;</div><div class="line">	// 产生不同的随机样本下标</div><div class="line">		List&lt;Integer&gt; rand = new ArrayList&lt;Integer&gt;(k);</div><div class="line">		for (int i = 0; i &lt; k; i++)&#123;</div><div class="line">			int temp = (int) (Math.random() * max);</div><div class="line">			if (!rand.contains(temp))&#123;</div><div class="line">				rand.add(temp);</div><div class="line">			&#125; else &#123;</div><div class="line">				i--;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public calDistance(List&lt;Double&gt; s1, List&lt;Double&gt; s2)&#123;</div><div class="line">	// 计算距离</div><div class="line">		double distance = 0.0;</div><div class="line">		for (int i = 0; i &lt; s1.size(); i++)&#123;</div><div class="line">			distance += (s1.get(i) - s2.get(i)) * (s1.get(i) - s2.get(i));</div><div class="line">		&#125;</div><div class="line">		return distance;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public String getMostClass(PriorityQueue&lt;KNN_node&gt;  pq)&#123;</div><div class="line">	// 统计优先队列中的KNN结点、 得到最有可能的类</div><div class="line">		Map&lt;String, intege&gt; classCount = new HashMap&lt;String, Integer&gt;();</div><div class="line">		for (int i = 0; i &lt; pq.size(); i++)&#123;</div><div class="line">			KNN_node node = pd.remove();</div><div class="line">			String label = node.getLabel();</div><div class="line">			if (classCount.containsKey(label))&#123;</div><div class="line">				classCount.put(label, classCount.get(label) + 1);</div><div class="line">			&#125; else &#123;</div><div class="line">				classCount.put(label, 1);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		int maxIndex = -1;</div><div class="line">		int maxCount = 0;</div><div class="line">		Object[] classes = classCount.keySet.toArray();</div><div class="line">		// you can use iterator instead</div><div class="line">		for (int i = 0; i &lt; classes.length; i++)&#123;</div><div class="line">			if (classCount.get(classes[i]) &gt; maxCount)&#123;</div><div class="line">				maxIndex = i;</div><div class="line">				maxCount = classCount.get(classes[i])</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		return classes[maxIndex].toString();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="2、kd树的实现"><a href="#2、kd树的实现" class="headerlink" title="2、kd树的实现"></a>2、kd树的实现</h1><h2 id="2-1、基本原理"><a href="#2-1、基本原理" class="headerlink" title="2.1、基本原理"></a>2.1、基本原理</h2><p>KD树：采用分而治之的思想，其本质是一种平衡二叉树。输入的样本点通过kd树快速找到哪些数据集样本点最有可能是其最近邻点</p>
<p>对于拥有n个已知点的kD-Tree，其复杂度如下：</p>
<ul>
<li>构建：O(log2n)</li>
<li>插入：O(log n)</li>
<li>删除：O(log n)</li>
<li>查询：O(n^(1-1/k) + m) m—每次要搜索的最近点个数</li>
</ul>
<h3 id="2-1-1、kd树的基本思想"><a href="#2-1-1、kd树的基本思想" class="headerlink" title="2.1.1、kd树的基本思想"></a>2.1.1、kd树的基本思想</h3><p>（以平衡kd树，2特征为例）  </p>
<ul>
<li>首先使用每个样本点的<strong>第一个特征</strong>，选出中位数，使用该中位数对于的样本点做为划分空间的（垂直该轴）线，即使用该样本点拓展出深度为2的二叉树。如左图的（7，1）点。</li>
<li>接下来按分开的空间依次用各自空间的每个样本点的第二个特征，求出两个中位数，分别分割各自的子空间，即使用该样本点拓展出深度为3的二叉树。</li>
<li>依次类推利用另一个特征（循环使用特征），依次用各自四个空间的每个样本点的第1个特征，求出四个中位数，分别分割各自的子空间，即使用该样本点拓展出深度为4的二叉树。</li>
<li>以此类推直到无法划分停止</li>
</ul>
<h3 id="2-1-2、例子"><a href="#2-1-2、例子" class="headerlink" title="2.1.2、例子"></a>2.1.2、例子</h3><p><strong>（例子转自一个写得挺好的博客 [2]）</strong></p>
<p>星号表示要查询的点（2.1,3.1）。通过二叉搜索，顺着搜索路径很快就能找到最邻近的近似点，也就是叶子节点（2,3）。而找到的叶子节点并不一定就是最邻近的，最邻近肯定距离查询点更近，应该位于以查询点为圆心且通过叶子节点的圆域内。为了找到真正的最近邻，还需要进行’回溯’操作：算法沿搜索路径反向查找是否有距离查询点更近的数据点。此例中先从（7,2）点开始进行二叉查找，然后到达（5,4），最后到达（2,3），此时搜索路径中的节点为小于（7,2）和（5,4），大于（2,3），首先以（2,3）作为当前最近邻点，计算其到查询点（2.1,3.1）的距离为0.1414，然后回溯到其父节点（5,4），并判断在该父节点的其他子节点空间中是否有距离查询点更近的数据点。以（2.1,3.1）为圆心，以0.1414为半径画圆，如下图所示。发现该圆并不和超平面y = 4交割，因此不用进入（5,4）节点右子空间中去搜索。</p>
<p><img src="http://img.my.csdn.net/uploads/201212/24/1356352628_9385.jpg" alt="image"></p>
<p>再回溯到（7,2），以（2.1,3.1）为圆心，以0.1414为半径的圆更不会与x = 7超平面交割，因此不用进入（7,2）右子空间进行查找。至此，搜索路径中的节点已经全部回溯完，结束整个搜索，返回最近邻点（2,3），最近距离为0.1414。</p>
<p>一个复杂点了例子如查找点为（2，4.5）。同样先进行二叉查找，先从（7,2）查找到（5,4）节点，在进行查找时是由y = 4为分割超平面的，由于查找点为y值为4.5，因此进入右子空间查找到（4,7），形成搜索路径&lt;（7,2），（5,4），（4,7）&gt;，取（4,7）为当前最近邻点，计算其与目标查找点的距离为3.202。然后回溯到（5,4），计算其与查找点之间的距离为3.041。以（2，4.5）为圆心，以3.041为半径作圆，如下图左所示。可见该圆和y = 4超平面交割，所以需要进入（5,4）左子空间进行查找。此时需将（2,3）节点加入搜索路径中得&lt;（7,2），（2,3）&gt;。回溯至（2,3）叶子节点，（2,3）距离（2,4.5）比（5,4）要近，所以最近邻点更新为（2，3），最近距离更新为1.5。回溯至（7,2），以（2,4.5）为圆心1.5为半径作圆，并不和x = 7分割超平面交割，如下图右所示。至此，搜索路径回溯完。返回最近邻点（2,3），最近距离1.5。</p>
<p> <img src="http://img.my.csdn.net/uploads/201212/24/1356352671_1629.jpg" alt="image">   </p>
<h3 id="2-1-3、python原理级的实现"><a href="#2-1-3、python原理级的实现" class="headerlink" title="2.1.3、python原理级的实现"></a>2.1.3、python原理级的实现</h3><p>由kd树的主要操作有建立，搜索，插入与删除。python的实现比较简单，下面的python代码使用字典结构来存放kd树，其中字典的key为相应子dataset中特征值中位数对应样本的下标，value值为下级的子kd树：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#kd_tree module</span></div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> pdb</div><div class="line"></div><div class="line"><span class="comment">##**********declare************##</span></div><div class="line"><span class="comment"># pdb.set_trace(): a beeakpoint</span></div><div class="line"><span class="comment">##****************************##</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">createTree</span><span class="params">(dataSet, labels)</span>:</span></div><div class="line">	nFeats = len(dataSet[<span class="number">0</span>]) - <span class="number">1</span></div><div class="line">	dataSet = addOrderNumForDataSet(dataSet)</div><div class="line">	myTree = createSubTree(dataSet, <span class="number">0</span>, nFeats)</div><div class="line">		<span class="comment"># build tree recursively</span></div><div class="line">	<span class="keyword">return</span> myTree</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">addOrderNumForDataSet</span><span class="params">(dataSet)</span>:</span></div><div class="line">	<span class="comment"># add order numbers for the dataSet</span></div><div class="line">	newDataSet = []</div><div class="line">	i = <span class="number">0</span></div><div class="line">	<span class="comment"># 这个函数中利用迭代器将ndarray中元素提取成list</span></div><div class="line">	<span class="comment"># 故可以用append与extend函数</span></div><div class="line">	<span class="keyword">for</span> sample <span class="keyword">in</span> dataSet:</div><div class="line">		sampleVec = [i]</div><div class="line">		i += <span class="number">1</span></div><div class="line">		sampleVec.extend(sample)</div><div class="line">		newDataSet.append(sampleVec)</div><div class="line">	<span class="keyword">return</span> newDataSet</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">createSubTree</span><span class="params">(dataSet, cntDeepth, nFeats)</span>:</span></div><div class="line">	<span class="comment"># a recursive method to bulid kd tree</span></div><div class="line">	<span class="keyword">if</span> len(dataSet) == <span class="number">0</span>:</div><div class="line">		<span class="keyword">return</span> <span class="string">'end'</span></div><div class="line">	<span class="keyword">if</span> len(dataSet) == <span class="number">1</span>:</div><div class="line">		<span class="keyword">return</span> dataSet[<span class="number">0</span>][<span class="number">0</span>]</div><div class="line">	cntInLoop = np.mod((cntDeepth + <span class="number">1</span>), nFeats) + <span class="number">1</span></div><div class="line">		<span class="comment"># calculate the counter in the loop of the index</span></div><div class="line">	leftDataSet, rightDataSet, midElemOrder = splitOffMidElemFromDataSet(dataSet, cntInLoop)</div><div class="line">		<span class="comment"># spilt the dataSet by rhe middle value of</span></div><div class="line">	myTree = &#123;midElemOrder: &#123;&#125;&#125;</div><div class="line">		<span class="comment"># initize the sub tree</span></div><div class="line">	myTree[midElemOrder][<span class="number">0</span>] = createSubTree(leftDataSet, cntDeepth + <span class="number">1</span>, nFeats)</div><div class="line">	myTree[midElemOrder][<span class="number">1</span>] = createSubTree(rightDataSet, cntDeepth + <span class="number">1</span>, nFeats)</div><div class="line">	<span class="keyword">return</span> myTree</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">splitOffMidElemFromDataSet</span><span class="params">(dataSet, feat)</span>:</span></div><div class="line">	<span class="comment"># find out middle value</span></div><div class="line">	featVal = [example[feat] <span class="keyword">for</span> example <span class="keyword">in</span> dataSet]</div><div class="line">		<span class="comment"># this is the method to get a kind of feat with ndarray</span></div><div class="line">		<span class="comment"># featVal = array(dataSet[:][feat]) # it's with DataFrame</span></div><div class="line">	featVal.sort()</div><div class="line">	len_feat = len(featVal)</div><div class="line">	midElemLoc = np.ceil(len_feat / <span class="number">2.0</span>).astype(np.int64) - <span class="number">1</span></div><div class="line"></div><div class="line">	midVal = featVal[midElemLoc]</div><div class="line">	midElem = dataSet[midElemLoc]</div><div class="line">	midElemOrder = dataSet[midElemLoc][<span class="number">0</span>]</div><div class="line">	dataSet = removeElemFromDataSet(dataSet, midElemLoc)</div><div class="line">	<span class="comment"># quick sort</span></div><div class="line">	i = <span class="number">-1</span></div><div class="line">		<span class="comment"># indictor</span></div><div class="line">	j = <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> np.arange(len_feat - <span class="number">1</span>):</div><div class="line">		<span class="keyword">if</span> dataSet[j][feat] &lt;= midVal:</div><div class="line">			i += <span class="number">1</span></div><div class="line">			exchage(dataSet, i, j)</div><div class="line">	<span class="keyword">return</span> dataSet[<span class="number">0</span> : i + <span class="number">1</span>], dataSet[i + <span class="number">1</span> :], midElemOrder</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">removeElemFromDataSet</span><span class="params">(dataSet, sampleLoc)</span>:</span></div><div class="line">	<span class="comment"># remove the chosen sample from dataSet</span></div><div class="line">	retDataSet = np.zeros(np.size(dataSet))</div><div class="line">	dataSet[: sampleLoc]</div><div class="line">		<span class="comment"># 挖出axis轴特征含有value值的samples，去掉axis特征</span></div><div class="line">	retDataSet = dataSet[: sampleLoc]</div><div class="line">	retDataSet = appendForNdarray(retDataSet, dataSet[sampleLoc + <span class="number">1</span> :], sampleLoc)</div><div class="line">	<span class="keyword">return</span> retDataSet</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">appendForNdarray</span><span class="params">(retDataSet, dataSet, sampleLoc)</span>:</span></div><div class="line">	newLen = len(retDataSet) + len(dataSet)</div><div class="line">	featLen = len(dataSet[<span class="number">0</span>])</div><div class="line">	retDataSet = np.resize(retDataSet, (newLen, featLen))</div><div class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(len(dataSet)):</div><div class="line">		retDataSet[i + sampleLoc] = dataSet[i]</div><div class="line">	<span class="keyword">return</span> retDataSet</div><div class="line"></div><div class="line"><span class="comment"># other function</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">exchage</span><span class="params">(dataSet, i, j)</span>:</span></div><div class="line">	temp = dataSet[i]</div><div class="line">	dataSet[i] = dataSet[j]</div><div class="line">	dataSet[j] = temp</div></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">myTree = kd_tree.createTree(normDataSet, Labels)</div></pre></td></tr></table></figure>
<h2 id="2-2、java代码实现"><a href="#2-2、java代码实现" class="headerlink" title="2.2、java代码实现"></a>2.2、java代码实现</h2><p>如下图，给定一个给定二维数据集合：(2,3), (5,4), (9,6), (4,7), (8,1), (7,2)。树的非叶节点用于做搜索判断，而叶节点用于存储数据。可以发现kd树是二叉平衡搜索树，而根节点不是null，而是存储着数据。实际情况下，kd树的根节点存放的并不是数据，更多时候是数据的索引（如哈希表）、下标或是地址。<br><img src="http://img.blog.csdn.net/20131026120154796" alt="image"></p>
<h3 id="2-2-1、预定义类"><a href="#2-2-1、预定义类" class="headerlink" title="2.2.1、预定义类"></a>2.2.1、预定义类</h3><p>为了方便，这里定义基本基础的类，依次是样本类、节点类（叶节点与非叶节点）</p>
<ul>
<li>样本类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sample</span></span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> index;</div><div class="line">	<span class="keyword">private</span> List&lt;Double&gt; features;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> label;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Sample</span><span class="params">(<span class="keyword">int</span> index, List&lt;Double&gt; features, <span class="keyword">int</span> label)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.setIndex(index);</div><div class="line">		<span class="keyword">this</span>.setFeatures(features);</div><div class="line">		<span class="keyword">this</span>.setLabel(label);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Sample</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">double</span>[] featsArray, <span class="keyword">int</span> label)</span></span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; featsArray.length; i++)&#123;</div><div class="line">			List&lt;Double&gt; features = <span class="keyword">new</span> List&lt;Double&gt;();</div><div class="line">			features.add(featsArray[i]);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">this</span>.setIndex(index);</div><div class="line">		<span class="keyword">this</span>.setFeatures(features);</div><div class="line">		<span class="keyword">this</span>.setLabel(label);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.index; &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">setIndex</span><span class="params">(<span class="keyword">int</span> index)</span></span>&#123; <span class="keyword">this</span>.index = index; &#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">getFeatures</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.features; &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">getFeatAt</span><span class="params">(<span class="keyword">int</span> loc)</span></span>&#123;</div><div class="line">		<span class="keyword">if</span> (loc &gt;= <span class="number">0</span> &amp;&amp; loc &lt; <span class="keyword">this</span>.features.size())&#123;</div><div class="line">			<span class="keyword">return</span> features.get(loc);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"the access at features is invaid!"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">setFeatures</span><span class="params">(List&lt;Double&gt; features)</span></span>&#123; <span class="keyword">this</span>.features = features; &#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">getLabel</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.label; &#125;;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">setLabel</span><span class="params">(<span class="keyword">int</span> label)</span></span>&#123; <span class="keyword">this</span>.label = label; &#125;;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>节点类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isLeaf;</div><div class="line">	<span class="keyword">private</span> Sample sample;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">boolean</span> type)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.isLeaf = isLeaf;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLeafNode</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.isLeaf; &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSample</span><span class="params">()</span></span>&#123; <span class="keyword">this</span>.sample = sample; &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> Sample <span class="title">getSample</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.sample; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node_leaf</span> <span class="keyword">extends</span> <span class="title">Node</span></span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Node_leaf</span><span class="params">(Sample sample)</span></span>&#123;</div><div class="line">		<span class="keyword">super</span>(<span class="keyword">true</span>);</div><div class="line">		<span class="keyword">this</span>.setSample(sample);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node_nonLeaf</span> <span class="keyword">extends</span> <span class="title">Node</span></span>&#123;</div><div class="line">	<span class="keyword">private</span> Node leftChild = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> Node rightChild = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> featLoc = <span class="number">0</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">double</span> midVal = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Node_nonLeaf</span><span class="params">(<span class="keyword">int</span> featLoc, <span class="keyword">double</span> midVal, Sample sample)</span></span>&#123;</div><div class="line">		<span class="keyword">super</span>(<span class="keyword">false</span>);</div><div class="line">		<span class="keyword">this</span>.setFeatLoc(featLoc);</div><div class="line">		<span class="keyword">this</span>.setMidVal(midVal);</div><div class="line">		<span class="keyword">this</span>.setSample(sample);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// default args can not be used in java,</span></div><div class="line">	<span class="comment">// so we ovweride the constructor</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Node_nonLeaf</span><span class="params">(<span class="keyword">int</span> featLoc, <span class="keyword">double</span> midVal, Sample sample, Node leftChild, Node rightChild)</span></span>&#123;</div><div class="line">		<span class="keyword">super</span>(<span class="keyword">false</span>);</div><div class="line">		<span class="keyword">this</span>.setFeatLoc(featLoc);</div><div class="line">		<span class="keyword">this</span>.setMidVal(midVal);</div><div class="line">		<span class="keyword">this</span>.setSample(sample);</div><div class="line">		<span class="keyword">this</span>.setLeftChild(leftChild);</div><div class="line">		<span class="keyword">this</span>.setRightChild(rightChild);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFeatLoc</span><span class="params">(<span class="keyword">int</span> featLoc)</span></span>&#123; <span class="keyword">this</span>.featLoc = featLoc; &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getFeatLoc</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.featLoc; &#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMidVal</span><span class="params">(<span class="keyword">double</span> midVal)</span></span>&#123; <span class="keyword">this</span>.midVal = midVal; &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getMidVal</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.midVal; &#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLeftChild</span><span class="params">(Node leftChild)</span></span>&#123; <span class="keyword">this</span>.leftChild = leftChild; &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> Node <span class="title">getLeftChild</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.leftChild; &#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRightChild</span><span class="params">(Node rightChild)</span></span>&#123; <span class="keyword">this</span>.rightChild = rightChild; &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> Node <span class="title">getRightChild</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.rightChild; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还有一个比较运算时用的类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">class SortUnit implements Comparable&lt;SortUnit&gt; &#123;</div><div class="line">	public int index;</div><div class="line">	public double value;</div><div class="line"></div><div class="line">	public SortUnit(int index, double value)&#123;</div><div class="line">		this.index = index;</div><div class="line">		this.value = value;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	private double compareTo(SortUnit unit)&#123;</div><div class="line">		return this.value.compareTo(o2.value);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-2、构建kd树"><a href="#2-2-2、构建kd树" class="headerlink" title="2.2.2、构建kd树"></a>2.2.2、构建kd树</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Kd_tree</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">        List&lt;Sample&gt; trainSet = <span class="keyword">new</span> ArrayList&lt;Sample&gt;();</div><div class="line">        <span class="keyword">int</span> nSample = <span class="number">8</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nSample; i++)&#123;</div><div class="line">			trainSet.add(<span class="keyword">new</span> Sample());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		trainSet.add(<span class="keyword">new</span> Sample(<span class="number">0</span>, [<span class="number">1.0</span>, <span class="number">1.0</span>], <span class="number">0</span>));</div><div class="line">		trainSet.add(<span class="keyword">new</span> Sample(<span class="number">1</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>], <span class="number">1</span>));</div><div class="line">		trainSet.add(<span class="keyword">new</span> Sample(<span class="number">2</span>, [<span class="number">1.0</span>, <span class="number">0.0</span>], <span class="number">0</span>));</div><div class="line">		trainSet.add(<span class="keyword">new</span> Sample(<span class="number">3</span>, [<span class="number">0.0</span>, <span class="number">1.0</span>], <span class="number">1</span>));</div><div class="line"></div><div class="line">		ArrayList&lt;Double&gt; testSample = <span class="keyword">new</span> ArrayList&lt;Double&gt;();</div><div class="line">		testSample.add(<span class="number">0.0</span>);testSample.add(<span class="number">1.0</span>);</div><div class="line"></div><div class="line">        Kd_tree knn = <span class="keyword">new</span> Kd_tree(trainSet, <span class="number">3</span>);</div><div class="line"></div><div class="line">        <span class="comment">// System.out.println(knn.predict(testSample));</span></div><div class="line">        <span class="comment">// System.out.println(Arrays.toString(knn.predict_prob(testSample).toArray()));</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line">	<span class="comment">/* property */</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> deepth;</div><div class="line">	<span class="keyword">private</span> Node tree;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> kVal;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setK</span><span class="params">(<span class="keyword">int</span> kVal)</span></span>&#123; <span class="keyword">this</span>.kVal = kVal; &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getK</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.kVal; &#125;</div><div class="line"></div><div class="line">	<span class="comment">/* constructor */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Kd_tree</span><span class="params">(List&lt;Sample&gt; dataset, <span class="keyword">int</span> kVal)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.tree = createTree(dataset);</div><div class="line">		<span class="keyword">this</span>.setK(kVal);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* method */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Node <span class="title">createTree</span><span class="params">(List&lt;Sample&gt; dataset)</span></span>&#123;</div><div class="line">		List&lt;Integer&gt; indexs = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dataset.size(); i++)&#123;</div><div class="line">			indexs.add(dataset.get(i).getIndex());</div><div class="line">		&#125;</div><div class="line">		Node head = createSubTree(dataset, indexs, <span class="number">0</span>);</div><div class="line">		<span class="keyword">return</span> head;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> Node <span class="title">createSubTree</span><span class="params">(List&lt;Sample&gt; dataset, List&lt;Double&gt; indexs, <span class="keyword">int</span> featLoc)</span></span>&#123;</div><div class="line">		<span class="keyword">if</span> (indexs.isEmpty())&#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (indexs.size() == <span class="number">1</span>)&#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> Node_leaf(dataset.get(index.get(<span class="number">0</span>)));</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">int</span> midIndex = popMidSampleIndex(dataset, indexs, featLoc);</div><div class="line">			Sample midSample = dataset.get(midIndex);</div><div class="line">			<span class="keyword">int</span> midVal = midSample.get(featLoc);</div><div class="line"></div><div class="line"></div><div class="line">			Node node = <span class="keyword">new</span> Node(featLoc, midVal, midSample);</div><div class="line"></div><div class="line">			List&lt;Integer&gt; leftTreeIndexs = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">			List&lt;Integer&gt; rightTreeIndexs = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line"></div><div class="line">			<span class="keyword">int</span> nSample = indexs.size();</div><div class="line">			<span class="keyword">int</span> nFeat = dataset.get(indexs.get(<span class="number">0</span>)).size() - <span class="number">1</span>;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nSample; i++)&#123;</div><div class="line">				<span class="keyword">if</span> (dataset.get(indexs.get(i)).getFeatAt(featLoc) &lt; midVal)&#123;</div><div class="line">					leftTreeIndexs.add(indexs.get(i));</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					rightTreeIndexs.add(indexs.get(i));</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			node.setLeftChild(createSubTree(dataset, leftTreeIndexs, (featLoc + <span class="number">1</span>) % nFeat));</div><div class="line">			node.setRightChild(createSubTree(dataset, rightTreeIndexs, (featLoc + <span class="number">1</span>) % nFeat));</div><div class="line"></div><div class="line">			<span class="comment">// clear gc</span></div><div class="line">			indexs = <span class="keyword">null</span>;</div><div class="line">			System.gc();</div><div class="line"></div><div class="line">			<span class="keyword">return</span> node;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 将下面的两个函数写成比较器</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">popMidSampleIndex</span><span class="params">(List&lt;Sample&gt; dataset, List&lt;Integer&gt; indexs, <span class="keyword">int</span> featLoc)</span></span>&#123;</div><div class="line">		<span class="keyword">int</span> index = getMidValIndex(dataset, indexs, featLoc);</div><div class="line">		indexs.set(index, indexs.get(-<span class="number">1</span>));</div><div class="line">		indexs.remove(-<span class="number">1</span>);</div><div class="line">		<span class="keyword">return</span> index;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">getMidValIndex</span><span class="params">(List&lt;Sample&gt; dataset, List&lt;Integer&gt; indexs, <span class="keyword">int</span> featLoc)</span></span>&#123;</div><div class="line">		List&lt;SortUnit&gt; sortList = <span class="keyword">new</span> ArrayList&lt;SortUnit&gt;();</div><div class="line">		<span class="keyword">int</span> nSample = indexs.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nSample; i++)&#123;</div><div class="line">			sortList.add(<span class="keyword">new</span> SortUnit(indexs.get(i), dataset.get(indexs.get(i)).getFeatAt(featLoc)));</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Double[] sortArray = (Double[]) unsortedList.toArray();</span></div><div class="line">		<span class="comment">// Arrays.sort(sortArray);</span></div><div class="line">		Collections.sort(sortList);</div><div class="line">		<span class="keyword">return</span> sortList.get(nSample / <span class="number">2</span>).index;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-3、插入操作"><a href="#2-2-3、插入操作" class="headerlink" title="2.2.3、插入操作"></a>2.2.3、插入操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Kd_tree</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSample</span><span class="params">(List&lt;Sample&gt; dataset, Sample sample)</span></span>&#123;</div><div class="line">		Node node = <span class="keyword">this</span>.tree;</div><div class="line">		sample.setIndex(dataset.size());</div><div class="line">		dataset.add(sample);</div><div class="line">		<span class="keyword">if</span> (node == <span class="keyword">null</span>)&#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"the kd tree is empty!"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (node.isLeafNode() == <span class="number">1</span>)&#123;		</div><div class="line">			List&lt;Integer&gt; indexs = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">			indexs.add(sample.getIndex());</div><div class="line">			indexs.add(node.getIndex.get(<span class="number">0</span>));</div><div class="line">			<span class="keyword">this</span>.tree = createSubTree(dataset, indexs, (parent.getFeatLoc() + <span class="number">1</span>) % nFeat);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		Node preParent = <span class="keyword">null</span>;</div><div class="line">		Node parent = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">boolean</span> isLeafChild;</div><div class="line">		<span class="keyword">while</span> (node.isLeafNode() != <span class="number">1</span>)&#123;</div><div class="line">			<span class="keyword">int</span> featLoc = node.getFeatLoc();</div><div class="line">			<span class="keyword">if</span> (sample.get(featLoc) &lt; node.midVal)&#123;</div><div class="line">				<span class="keyword">if</span> (node.getLeftChild() == <span class="keyword">null</span>)&#123;</div><div class="line">					node.setLeftChild(<span class="keyword">new</span> Node_leaf(sample));</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					preParent = parent;</div><div class="line">					parent = node;</div><div class="line">					node = node.getLeftChild();</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">if</span> (node.getRightChild() == <span class="keyword">null</span>)&#123;</div><div class="line">					node.setRightChild(<span class="keyword">new</span> Node_leaf(sample));</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					preParent = parent;</div><div class="line">					parent = node;</div><div class="line">					node = node.getRightChild();</div><div class="line">				&#125;				</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		List&lt;Integer&gt; indexs = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">		indexs.add(sample.getIndex());</div><div class="line">		indexs.add(node.getIndex.get(<span class="number">0</span>));</div><div class="line">		indexs.add(parent.getIndex.get(<span class="number">0</span>));</div><div class="line">		<span class="keyword">int</span> nFeat = dataset.get(indexs.get(<span class="number">0</span>)).size() - <span class="number">1</span>;</div><div class="line">		Node subTree = createSubTree(dataset, indexs, parent.getFeatLoc());</div><div class="line">		<span class="keyword">if</span> (preParent == <span class="keyword">null</span>)&#123;</div><div class="line">			<span class="keyword">this</span>.tree = subTree;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (preParent.getLeftChild().equals(parent))&#123;</div><div class="line">				preParent.setLeftChild(subTree);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				preParent.setRightChild(subTree);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;		</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-4、删除操作"><a href="#2-2-4、删除操作" class="headerlink" title="2.2.4、删除操作"></a>2.2.4、删除操作</h4><h4 id="2-2-5、搜索操作"><a href="#2-2-5、搜索操作" class="headerlink" title="2.2.5、搜索操作"></a>2.2.5、搜索操作</h4><blockquote>
<ul>
<li>单最近邻点搜索：<ul>
<li>在kd树种找出包含目标点x的叶结点：从根结点出发，递归地向下搜索kd树。若目标点x当前维的坐标小于切分点的坐标，则移动到左子结点，否则移动到右子结点，直到子结点为叶结点为止。</li>
<li>以此叶结点为“当前最近点”。</li>
<li>递归的向上回溯，在每个结点进行以下操作：<ul>
<li>（a）如果该结点保存的实例点比当前最近点距离目标点更近，则更新“当前最近点”，也就是说以该实例点为“当前最近点”。</li>
<li>（b）当前最近点一定存在于该结点一个子结点对应的区域，检查子结点的父结点的另一子结点对应的区域是否有更近的点。具体做法是，检查另一子结点对应的区域是否以目标点位球心，以目标点与“当前最近点”间的距离为半径的圆或超球体相交：<br>如果相交，可能在另一个子结点对应的区域内存在距目标点更近的点，移动到另一个子结点，接着，继续递归地进行最近邻搜索；如果不相交，向上回溯。</li>
</ul>
</li>
<li>当回退到根结点时，搜索结束，最后的“当前最近点”即为x 的最近邻点。<br>引用自：博客[1]</li>
</ul>
</li>
</ul>
</blockquote>
<p><strong>代码：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Sample <span class="title">searchNearestSample</span><span class="params">(List&lt;Sample&gt; dataset, Sample target)</span></span>&#123;</div><div class="line">	Node node = <span class="keyword">this</span>.tree;</div><div class="line">	Node nearest = node;</div><div class="line">	<span class="keyword">double</span> minDist = nearest.getSample.getDistance(target);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (node == <span class="keyword">null</span>)&#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"the kd tree is empty!"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// direct search</span></div><div class="line">	Stack&lt;Node&gt; searchPath = <span class="keyword">new</span> Stack&lt;Node&gt;();</div><div class="line">	<span class="keyword">while</span>(node != <span class="keyword">null</span>)&#123;</div><div class="line">		searchPath.push(node);</div><div class="line">		<span class="keyword">if</span> (nearest.getSample.getDistance(target) &gt; node.getSample.getDistance(target))&#123;</div><div class="line">			nearest = node;</div><div class="line">			minDist = node.getSample.getDistance(target);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!node.isLeafNode())&#123;</div><div class="line">			<span class="keyword">if</span> (target.getFeatAt(node.getFeatLoc()) &lt; node.getMidVal())&#123;</div><div class="line">				node = node.getLeftChild();</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				node = node.getRightChild();</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span>&#123;</div><div class="line">			node = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// backtracking search</span></div><div class="line">	<span class="keyword">while</span> (!searchPath.isEmpty())&#123;</div><div class="line">		node = searchPath.pop();</div><div class="line">		<span class="keyword">if</span> (node.getSample.getDistance() &lt; minDist)&#123;</div><div class="line">		<span class="comment">// so we need to enter the another subtree</span></div><div class="line">			<span class="keyword">if</span> (!node.isLeafNode())&#123;				</div><div class="line">				<span class="keyword">if</span> (target.getFeatAt(node.getFeatLoc()) &lt; node.getMidVal())&#123;</div><div class="line">				<span class="comment">// if target in the sub-left-tree</span></div><div class="line">					node = node.getRightChild();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					node = node.getleftChild();</div><div class="line">				&#125;</div><div class="line">				searchPath.push(node);</div><div class="line">			&#125;</div><div class="line">			nearest = node;</div><div class="line">			minDist = node.getSample.getDistance(target);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> nearest.getSample();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>使用最大堆找寻k个最近邻，<ul>
<li>在单最近邻点的回溯过程中，将访问过可能是最近邻比较过的点都与容量为k的最小堆比较，更新最小堆</li>
<li>结束后即可获得k个最近邻点</li>
</ul>
</li>
</ul>
<p><strong>代码：仅添加了几行更新堆的代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Sample&gt; <span class="title">getNearestKSamples</span><span class="params">(List&lt;Sample&gt; dataset, Sample sample)</span></span>&#123;</div><div class="line">	Node node = <span class="keyword">this</span>.tree;</div><div class="line">	Heap&lt;Sample&gt; nearestHeap = <span class="keyword">new</span> Heap&lt;Sample&gt;(<span class="keyword">this</span>.kVal);</div><div class="line">	<span class="comment">// 需要自己实现个最小堆</span></div><div class="line">	Node nearest = node;</div><div class="line">	<span class="keyword">double</span> minDist = nearest.getSample.getDistance(target);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (node == <span class="keyword">null</span>)&#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"the kd tree is empty!"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// direct search</span></div><div class="line">	Stack&lt;Node&gt; searchPath = <span class="keyword">new</span> Stack&lt;Node&gt;();</div><div class="line">	<span class="keyword">while</span>(node != <span class="keyword">null</span>)&#123;</div><div class="line">		searchPath.push(node);</div><div class="line">		<span class="keyword">if</span> (nearest.getSample.getDistance(target) &gt; node.getSample.getDistance(target))&#123;</div><div class="line">			nearest = node;</div><div class="line">			minDist = node.getSample.getDistance(target);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!node.isLeafNode())&#123;</div><div class="line">			<span class="keyword">if</span> (target.getFeatAt(node.getFeatLoc()) &lt; node.getMidVal())&#123;</div><div class="line">				node = node.getLeftChild();</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				node = node.getRightChild();</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span>&#123;</div><div class="line">			nearestHeap.update(node.getSample());</div><div class="line">			node = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// backtracking search</span></div><div class="line">	<span class="keyword">while</span> (!searchPath.isEmpty())&#123;</div><div class="line">		node = searchPath.pop();</div><div class="line">		nearestHeap.update(node.getSample());</div><div class="line">		<span class="keyword">if</span> (node.getSample.getDistance() &lt; minDist)&#123;</div><div class="line">		<span class="comment">// so we need to enter the another subtree</span></div><div class="line">			<span class="keyword">if</span> (!node.isLeafNode())&#123;				</div><div class="line">				<span class="keyword">if</span> (target.getFeatAt(node.getFeatLoc()) &lt; node.getMidVal())&#123;</div><div class="line">				<span class="comment">// if target in the sub-left-tree</span></div><div class="line">					node = node.getRightChild();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					node = node.getleftChild();</div><div class="line">				&#125;</div><div class="line">				searchPath.push(node);</div><div class="line">			&#125;</div><div class="line">			nearest = node;</div><div class="line">			minDist = node.getSample.getDistance(target);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> nearestHeap.getValues();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-3、kd-tree-with-BBF（kd树改进算法）"><a href="#2-3、kd-tree-with-BBF（kd树改进算法）" class="headerlink" title="2.3、kd-tree with BBF（kd树改进算法）"></a>2.3、kd-tree with BBF（kd树改进算法）</h2><p>若实例点是随机分布的，那么kd树搜索的平均计算复杂度是O（NlogN），这里的N是训练样本数量。故kd树更适用于训练样本数远大于特征维数的k近邻搜索，当特征维数接近训练样本数时，它的效率基本降为线性扫描的速度。</p>
<p><strong>BBF（Best-Bin-First）是适用于高维特征的kd树算法</strong></p>
<p>BBF算法的思想对查询路径上的节点进行排序，如按照各自及节点与目标点的距离排序。在回溯过程中，对查询路径上的节点按排序顺序进行优先级访问，保证最先访问到包含最近邻点可能性最大的空间。具体介绍如博客[1]：</p>
<ul>
<li>它是由发明sift算法的David Lowe在1997的一篇文章中针对高维数据提出的一种近似算法，此算法能确保优先检索包含最近邻点可能性较高的空间，此外，BBF机制还设置了一个运行超时限定。采用了BBF查询机制后，kd树便可以有效的扩展到高维数据集上。</li>
</ul>
<hr>
<ul>
<li>上面的一段引用以代码流程来说就是：<ul>
<li>1、将搜索代码中的栈searchPath改成队列，回溯时对该队列进行排序（即一个优先队列）</li>
<li>2、设定一个限定时间</li>
<li>3、按照优先队列的优先级顺序输出的节点去访问相应的空间，更新最小堆nearestHeap</li>
<li>4、一直执行3直至队列为空或限定时间到时</li>
<li>5、在该时间内若没有完成则退出搜索，并返回当前的k个最近邻点；若在限定时间内队列为空结束，返回当前的k个最近邻点</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li><p>例子依旧\(•ω•)⁄来自<strong>博客[1]</strong><br><img src="http://img.my.csdn.net/uploads/201211/20/1353406276_4095.jpg" alt="image"></p>
</li>
<li><p>将（7,2）压人优先队列中；</p>
</li>
<li>提取优先队列中的（7,2），由于（2,4.5）位于（7,2）分割超平面的左侧，所以检索其左子结点（5,4）。同时，根据BBF机制”搜索左/右子树，就把对应这一层的兄弟结点即右/左结点存进队列”，将其（5,4）对应的兄弟结点即右子结点（9,6）压人优先队列中，此时优先队列为{（9,6）}，最佳点为（7,2）；然后一直检索到叶子结点（4,7），此时优先队列为{（2,3），（9,6）}，“最佳点”则为（5,4）；</li>
<li>提取优先级最高的结点（2,3），重复步骤2，直到优先队列为空。</li>
</ul>
<p>代码：（有空再写\(•ω•)⁄）</p>
<p><strong>其他的k近邻实现方法：球树、M树、VP树、MVP树</strong>见参考博客[1]<br>其中VP树、MVP树是针对高维特征的算法</p>
<hr>
<p>参考博客:</p>
<ul>
<li>[1] <a href="http://www.cnblogs.com/v-July-v/archive/2012/11/20/3125419.html" target="_blank" rel="external">http://www.cnblogs.com/v-July-v/archive/2012/11/20/3125419.html</a></li>
<li>[2] <a href="http://blog.csdn.net/qll125596718/article/details/842645" target="_blank" rel="external">http://blog.csdn.net/qll125596718/article/details/842645</a></li>
<li>[3] <a href="http://blog.sina.com.cn/s/blog_6f611c300101bysf.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_6f611c300101bysf.html</a></li>
<li>[4] <a href="http://blog.csdn.net/likika2012/article/details/39619687" target="_blank" rel="external">http://blog.csdn.net/likika2012/article/details/39619687</a></li>
<li>[5] <a href="http://www.cnblogs.com/7899-89/p/3620346.html" target="_blank" rel="external">http://www.cnblogs.com/7899-89/p/3620346.html</a></li>
</ul>
<p>参考书籍：</p>
<ul>
<li>[1]《机器学习实战》的knn章节</li>
</ul>
<p>参考论文：</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="geelin" />
          <p class="site-author-name" itemprop="name">geelin</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">geelin</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
